#!/bin/bash
# Quick sync to Hostinger VPS production
# With quality gates for code deployments

echo "ğŸš€ Sync to Hostinger VPS (app.fibreflow.app)"
echo ""

# Quality gates for code deployment
if [[ "$@" == *"--code"* ]]; then
    echo "ğŸ”’ QUALITY GATES ENABLED (code deployment detected)"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    # Gate 1: Tests
    if [ -d "tests" ] && [ -f "venv/bin/pytest" ]; then
        echo "ğŸ§ª Running tests..."
        ./venv/bin/pytest tests/ -v --tb=short || {
            echo "âŒ Tests failed! Deployment aborted."
            echo "Fix failing tests before deploying to production."
            exit 1
        }
        echo "âœ… Tests passed"
    else
        echo "âš ï¸  No tests found or pytest not installed (skipping)"
    fi

    # Gate 2: Type check (Python)
    if [ -f "venv/bin/mypy" ]; then
        echo "ğŸ” Type checking..."
        ./venv/bin/mypy . --ignore-missing-imports --no-error-summary 2>/dev/null || {
            echo "âš ï¸  Type check warnings (non-blocking)"
        }
        echo "âœ… Type check complete"
    fi

    # Gate 3: Linting (Python)
    if [ -f "venv/bin/black" ]; then
        echo "ğŸ¨ Checking code formatting..."
        ./venv/bin/black --check . 2>/dev/null || {
            echo "âš ï¸  Code formatting issues (non-blocking)"
            echo "ğŸ’¡ Run './venv/bin/black .' to auto-format"
        }
    fi

    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âœ… All quality gates passed!"
    echo ""
fi

echo "Options:"
echo "  ./sync-to-hostinger           # Sync documentation only (safe)"
echo "  ./sync-to-hostinger --code    # Sync docs + code + run quality gates"
echo "  ./sync-to-hostinger --restart # Sync docs + restart PM2"
echo "  ./sync-to-hostinger --code --restart # Full sync + quality gates + restart"
echo ""

python3 .claude/skills/hostinger-vps/scripts/sync_all.py "$@"